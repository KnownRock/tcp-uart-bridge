# TCP-UART 桥接器

[English](./README.md) | 中文文档

一个基于 Node.js 的 TCP-UART 桥接应用程序，通过串口通信实现多端口映射。该工具允许您通过 UART 接口隧道化 TCP 连接，非常适用于物联网设备、嵌入式系统和远程网络访问场景。

## 功能特性

- **多端口映射**：配置多个本地端口映射到不同的远程主机和端口
- **二进制协议**：针对高效串行通信优化的二进制数据包格式
- **客户端管理**：基于 UUID 标识的高级客户端会话管理
- **灵活配置**：基于 JSON 的端口映射配置
- **全面日志**：支持文件输出的多级日志系统
- **流控制**：可配置的 UART 流控制设置
- **错误处理**：健壮的错误处理和连接恢复机制

## 安装

1. 克隆仓库：
```bash
git clone https://github.com/knownrock/tcp-uart-bridge.git
cd tcp-uart-bridge
```

2. 安装依赖：
```bash
npm install
```

## 配置

### 端口映射配置

编辑 `port-mapping.json` 来配置您的端口映射：

```json
{
  "portMappings": [
    {
      "localPort": 8080,
      "remoteHost": "localhost",
      "remotePort": 22,
      "description": "SSH转发到本地22端口"
    },
    {
      "localPort": 8081,
      "remoteHost": "localhost",
      "remotePort": 80,
      "description": "HTTP转发到本地80端口"
    }
  ]
}
```

### 环境变量

- `DEBUG=true`：启用调试日志
- `QUIET=true`：禁用信息日志
- `VERBOSE=true`：启用详细日志

## 使用方法

### TCP 服务器模式

运行 TCP 服务器，监听传入连接并通过 UART 转发：

```bash
npm run server
# 或者
node tcp-server.js [串口名称] [波特率] [流控制] [映射文件]
```

参数：
- `串口名称`：串口名称（默认：COM1）
- `波特率`：波特率（默认：115200）
- `流控制`：启用流控制（默认：true）
- `映射文件`：端口映射配置文件（默认：port-mapping.json）

示例：
```bash
node tcp-server.js COM3 115200 true port-mapping.json
```

### TCP 客户端模式

运行 TCP 客户端，从 UART 接收数据并转发到目标主机：

```bash
npm run client
# 或者
node tcp-client.js [串口名称] [波特率] [流控制]
```

示例：
```bash
node tcp-client.js COM3 115200 true
```

### 可用脚本

- `npm run server`：启动 TCP 服务器
- `npm run client`：启动 TCP 客户端
- `npm run test`：运行测试客户端
- `npm run check-ports`：检查可用串口
- `npm run test-http`：启动 HTTP 测试服务器

## 协议规范

应用程序使用优化的二进制协议进行串行通信：

```
数据包格式：
+--------+----------+----------+----------+-----------+----------+
|  命令  | 客户端ID |  目标IP  | 目标端口  | 数据长度  |   数据   |
| (1B)   |  (16B)   |  (4B)    |   (2B)   |   (4B)    | (可变长) |
+--------+----------+----------+----------+-----------+----------+
```

### 命令类型

- `0x01`：数据传输
- `0x03`：断开客户端连接
- `0x05`：程序关闭

## 架构

### 服务器端 (tcp-server.js)
- 监听配置的本地端口
- 接受来自客户端的 TCP 连接
- 通过 UART 将数据转发到客户端
- 管理多个客户端会话

### 客户端 (tcp-client.js)
- 从 UART 接收数据
- 建立到目标主机的连接
- 通过 UART 转发响应
- 处理连接生命周期

### 通信流程

1. 客户端连接到服务器的本地端口
2. 服务器生成唯一客户端ID并通过UART转发连接数据
3. 客户端接收数据，连接到目标主机
4. 通过UART隧道进行双向数据流
5. 断开连接时进行连接清理

## 日志记录

应用程序包含全面的日志系统：

- **Debug（调试）**：详细的协议和连接信息
- **Info（信息）**：一般操作消息
- **Warn（警告）**：警告条件
- **Error（错误）**：错误条件和异常
- **Verbose（详细）**：扩展调试信息

根据配置，日志可以输出到控制台和/或文件。

## 使用场景

- **物联网设备通信**：通过 UART 连接物联网设备到云服务
- **远程系统访问**：通过串行连接访问远程系统
- **网络桥接**：通过串行链路桥接不同的网络段
- **开发和测试**：在隔离环境中测试网络应用程序
- **遗留系统集成**：将遗留串行系统与现代 TCP/IP 网络集成

## 系统要求

- Node.js >= 14.0.0
- 串口硬件接口
- 两端都需要兼容的 UART 设备

### 推荐的USB转串口模块

为了获得最佳性能，推荐使用 **CH9111 USB转串口模块**：

- **产品链接**：https://item.taobao.com/item.htm?id=917091076150
- **驱动下载**：https://www.wch.cn/download/file?id=315

该模块经过大量测试，能够为高速数据传输提供最佳性能。需要安装 CH9111 驱动程序才能正常工作。

### 3D打印外壳

项目提供了专为USB转串口模块设计的3D打印外壳：

- **3D模型文件**：`shell.step`（STEP格式）
- **文件格式**：ISO-10303-21 STEP文件，兼容大多数CAD软件
- **说明**：专为推荐的CH9111模块设计的保护外壳

该外壳为您的TCP-UART桥接设备提供物理保护和专业外观。您可以使用任何3D打印机配合标准PETG或ABS耗材来打印外壳。

## 依赖项

- `serialport`：串口通信
- `uuid`：唯一标识符生成

## 许可证

该项目采用 MIT 许可证 - 详情请参阅 [LICENSE](LICENSE) 文件。

## 贡献

1. Fork 仓库
2. 创建您的功能分支 (`git checkout -b feature/amazing-feature`)
3. 提交您的更改 (`git commit -m 'Add some amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 打开一个 Pull Request

## 支持

如果您遇到任何问题或有疑问，请在 GitHub 仓库上提交 issue。

## 未来计划

以下功能计划在未来的版本中实现：

### 流量均衡和带宽管理
- **多流带宽平衡**：当多个TCP流转换为单个串口流时，实现智能流量调度算法，防止单个流占用所有可用带宽
- **公平队列调度**：确保所有TCP连接都能获得公平的传输机会，避免因带宽竞争导致的TCP超时和重传
- **优先级队列**：支持为不同的TCP流设置优先级，重要连接可获得更高的带宽分配

### 连接管理优化
- **改进的TCP流关闭设计**：优化连接关闭流程，确保所有缓冲数据都能正确传输完成
- **优雅关闭机制**：实现更完善的连接关闭协商，减少数据丢失风险
- **连接状态监控**：增强连接状态跟踪，提供更详细的连接生命周期管理

### 性能增强
- **自适应缓冲区**：根据网络条件动态调整缓冲区大小
- **压缩支持**：可选的数据压缩功能，提高串口带宽利用率

## 更新日志

### 版本 2.2.0
- 改进的二进制协议，优化数据包格式
- 基于 UUID 标识的增强客户端管理
- 更好的错误处理和连接恢复
- 添加全面的日志系统
- 更新依赖项到最新版本
